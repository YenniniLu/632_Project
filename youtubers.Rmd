---
title: "Xinyi & Daiyan 632 Project"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```

```{r message=FALSE}
library(tidyverse)
library(stringr)
library(randomForest) 
library(vip) 
```

## Data Cleaning

Load the data and inspect:
```{r}
df_raw <- read.csv("data.csv")
head(df_raw)
```

We notice several problems, like:     

1. Views: The Views variable is in string format and the units are different, like "10K views", "10M views". We prefer it to be in number and in the same unit in order to conduct statistical analysis.       

2. Subscribers: The same problems as Views. The Subscribers variable is like "10K subscribers", "10M subscribers".       

3. Length: The video length is in string format, like "12:00", "1:12:00". We need it to be in number and in the same unit.       

4. Released: The Released variable is in string format, like "2 years age", "10 month ago". We need it to be in number and in the same unit.        

Therefore, we need to do data cleaning first.

```{r eval=FALSE}
# Unify units and convert string to number, like: 10K views -> 10, 10M views -> 10000
cleanViews <- function(str) {
  str <- str_remove(str, " views")
  last <- str_sub(str, -1)
  views <- str %>% str_remove(last) %>% as.numeric()
  if (last == "M") return(1000*views)
  else return(views)
}

# Unify units and convert string to number, like: 10K subscribers -> 10, 10M subscribers -> 10000
cleanSubscribers <- function(str) {
  str <- str_remove(str, " subscribers")
  last <- str_sub(str, -1)
  views <- str %>% str_remove(last) %>% as.numeric()
  if (last == "M") return(1000*views)
  else return(views)
}

# Convert time in string format to number of minutes, like: 12:00 -> 12, 1:12:00 -> 72
cleanLength <- function(str) {
  list <- str_split(str, ":")
  len <- length(list[[1]])
  if (len == 3) {
     h <- as.numeric(list[[1]][1])
     m <- as.numeric(list[[1]][2])
     return((m + 1) + 60*m)
  } else {
     m <- as.numeric(list[[1]][1])
     return(m+1)
  }
}

# Convert time to number of months ago, like: 1 years ago -> 12, 10 months ago to 10
cleanReleased <- function(str) {
  str <- str_remove(str, "Streamed ")
  list <- str_split(str, " ")
  if (list[[1]][2] == "years") return(as.numeric(list[[1]][1])*12)
  else return(as.numeric(list[[1]][1]))
}

# Remove NAs
df <- df_raw %>%  
  filter(
    !is.na(Released) & Released != ""
  ) 

# Clean the data
df <- df %>% mutate(
  Views = map_dbl(Views, cleanViews),
  Subscribers = map_dbl(Subscribers, cleanSubscribers),
  Length = map_dbl(Length, cleanLength),
  Released = map_dbl(Released, cleanReleased)
)

head(df)

# Save for future use
write_csv(df, "cleaned_data.csv")
```
After cleaning, Views, Subscribers, Released and Length are numbers, while Views, Subscribers are in K and Released and Length are in minute.

## Data Discovery

```{r}
df <- read_csv("cleaned_data.csv")
head(df)

table(df$CC)
boxplot(Views ~ CC, data = df)

summary(df$Length)
boxplot(df$Length)

summary(df$Released)
boxplot(df$Released)

pairs(Views ~ CC + Released + Length, data=df)
```

## Sentiment Analysis

TODO by Xinyi

## Linear Regression

TODO by Xinyi

## Random Forest

```{r}
set.seed(652)
rf1 <- randomForest(Views ~ CC + Released + Category + Length, importance = TRUE, data = df)
rf1
```

Use the `vip()` function to make a variable importance plot.  Which variables are most important? 

```{r}
vip(rf1, num_features = 14,  include_type = TRUE)
```

Make a plot of the predicted versus actual values using the out-of-bag data.  Add the 1-1 line to the plot.

```{r}
pred_df <- data.frame(
  Actual = df$Views,
  Predicted = predict(rf1) # makes predictions using OOB data
)
```

```{r}
ggplot(pred_df, aes(x = Predicted, y = Actual)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, color = "red")
```

## Conclusion

TODO




